(()=>{(()=>{let H=window.location.pathname||"/";document.addEventListener("DOMContentLoaded",()=>{if(H==="/"&&G(),H.startsWith("/media")){let M=W();Y(M?.reloadVideos)}H.startsWith("/users")&&Z(),H.startsWith("/playlists/")&&z()});function G(){M(),y(),f();function M(){let l=document.querySelector("#videosTable tbody"),d=document.getElementById("modalOverlay"),S=document.getElementById("modalCancel"),w=document.getElementById("modalTitle"),i=document.getElementById("modalContent"),C=document.getElementById("modalConfirm");if(!l||!d||!w||!i||!C)return;async function E(){let B=await(await fetch("/api/videos")).json();l.innerHTML="",B.forEach(s=>{let T=document.createElement("tr");T.innerHTML=`
            <td>${s.id}</td>
            <td>${s.title||"(no title)"}</td>
            <td>${s.artist||""}</td>
            <td>${s.year||""}</td>
            <td>${s.genre||""}</td>
            <td>
              <input type="checkbox" ${s.is_ident?"checked":""} data-id="${s.id}">
            </td>
            <td>${s.source_url?`<a href="${s.source_url}" target="_blank">source</a>`:""}</td>
            <td class="px-3 py-2 flex gap-2">
              <button data-id="${s.id}" class="editBtn px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Edit</button>
              <button data-id="${s.id}" class="deleteBtn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Delete</button>
            </td>
          `,l.appendChild(T),T.querySelector(".editBtn").addEventListener("click",()=>{w.textContent="Edit Video",i.innerHTML=`
              <div class="space-y-3">
                <label class="block text-sm font-medium">Title</label>
                <input id="edit_title" value="${s.title||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Artist</label>
                <input id="edit_artist" value="${s.artist||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Year</label>
                <input id="edit_year" value="${s.year||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Genre</label>
                <input id="edit_genre" value="${s.genre||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="flex items-center gap-2 mt-2">
                  <input id="edit_ident" type="checkbox" ${s.is_ident?"checked":""}>
                  Ident
                </label>
              </div>
            `,C.onclick=async()=>{await fetch(`/api/videos/${s.id}/edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:document.getElementById("edit_title").value,artist:document.getElementById("edit_artist").value,year:document.getElementById("edit_year").value,genre:document.getElementById("edit_genre").value,is_ident:document.getElementById("edit_ident").checked})}),o(),E()},r()}),T.querySelector(".deleteBtn").addEventListener("click",()=>{w.textContent="Delete Video",i.innerHTML=`
              <p class="text-red-400">Are you sure you want to delete:<br>
              <strong>${s.title||"(no title)"}</strong>?</p>
            `,C.onclick=async()=>{await fetch(`/api/videos/${s.id}`,{method:"DELETE"}),o(),E()},r()})}),l.querySelectorAll("input[type=checkbox]").forEach(s=>{s.addEventListener("change",async()=>{let T=s.dataset.id;await fetch(`/api/videos/${T}/ident`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_ident:s.checked})})})})}function r(){d.classList.remove("hidden")}function o(){d.classList.add("hidden")}S?.addEventListener("click",o),E()}function y(){let l=document.getElementById("nowPlaying");if(!l)return;async function d(){let w=await(await fetch("/api/now-playing")).json();l.textContent=JSON.stringify(w,null,2)}d(),setInterval(d,5e3)}function f(){let l=document.getElementById("playlists"),d=document.getElementById("newPlaylistForm");if(!l&&!d)return;let S=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],w=C=>{let E=(C||"").split(",").map(o=>o.trim().toLowerCase()).filter(Boolean);if(!E.length)return"Runs daily";let r=["sun","mon","tue","wed","thu","fri","sat"];return E.sort((o,h)=>r.indexOf(o)-r.indexOf(h)),E.map(o=>{let h=r.indexOf(o);return h>=0?S[h]:o}).join(", ")};async function i(){if(!l)return;let E=await(await fetch("/api/playlists")).json();l.innerHTML="",E.forEach(r=>{let o=document.createElement("div");o.className="flex flex-col gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 md:flex-row md:items-center md:justify-between",o.innerHTML=`
            <div>
              <p class="text-sm font-semibold text-white">${r.name}</p>
              <p class="text-xs text-gray-400">${r.description||"No description"}</p>
              <p class="text-[0.7rem] text-gray-500 mt-1">${w(r.active_days)}</p>
              ${r.is_active?'<span class="text-xs text-emerald-300 inline-flex items-center gap-1 mt-1">\u25CF Active</span>':""}
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <a href="/playlists/${r.id}" class="px-3 py-1.5 rounded-xl border border-white/15 text-purple-100 hover:bg-purple-900/30 transition">Open</a>
              <button data-id="${r.id}" class="activate-btn px-3 py-1.5 rounded-xl border border-emerald-400/40 text-emerald-200 hover:bg-emerald-500/20 transition" ${r.is_active?"disabled":""}>
                Set active
              </button>
              <button data-id="${r.id}" class="disable-btn px-3 py-1.5 rounded-xl border border-yellow-400/40 text-yellow-200 hover:bg-yellow-500/20 transition" ${r.is_active?"":"disabled"}>
                Disable
              </button>
              <button data-id="${r.id}" class="delete-btn px-3 py-1.5 rounded-xl border border-red-400/40 text-red-200 hover:bg-red-500/20 transition">
                Delete
              </button>
            </div>
          `,l.appendChild(o)}),l.querySelectorAll(".activate-btn").forEach(r=>{r.addEventListener("click",async()=>{let o=r.dataset.id;await fetch(`/api/playlists/${o}/activate`,{method:"POST"}),i()})}),l.querySelectorAll(".disable-btn").forEach(r=>{r.addEventListener("click",async()=>{let o=r.dataset.id;await fetch(`/api/playlists/${o}/deactivate`,{method:"POST"}),i()})}),l.querySelectorAll(".delete-btn").forEach(r=>{r.addEventListener("click",async()=>{let o=r.dataset.id;confirm("Delete this playlist? This cannot be undone.")&&(await fetch(`/api/playlists/${o}`,{method:"DELETE"}),i())})})}d?.addEventListener("submit",async C=>{C.preventDefault();let E=new FormData(d),r={name:E.get("name"),description:E.get("description"),active_days:E.getAll("days")};await fetch("/api/playlists",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),d.reset(),i()}),i()}}function W(){let M=document.getElementById("videosTableBody");if(!M)return null;let y=1,f=25,l=1,d="",S="",w=document.getElementById("videoPageInfo"),i=document.getElementById("videoPrev"),C=document.getElementById("videoNext"),E=document.getElementById("videoSearch"),r=document.getElementById("videoSourceFilter"),o=document.getElementById("modalOverlay"),h=document.getElementById("modalCancel"),B=document.getElementById("modalTitle"),s=document.getElementById("modalContent"),T=document.getElementById("modalConfirm");E?.addEventListener("input",()=>{d=E.value.trim(),y=1,k(1)}),r?.addEventListener("change",()=>{S=r.value,y=1,k(1)}),i?.addEventListener("click",()=>{y>1&&k(y-1)}),C?.addEventListener("click",()=>{y<l&&k(y+1)}),h?.addEventListener("click",()=>o?.classList.add("hidden")),k();function _(c){let u=Math.round(Number(c)||0);if(u<=0)return"\u2014";let g=Math.floor(u/3600),b=Math.floor(u%3600/60),x=u%60;return g>0?`${g}:${String(b).padStart(2,"0")}:${String(x).padStart(2,"0")}`:`${b}:${String(x).padStart(2,"0")}`}function k(c=1){y=c;let u=new URLSearchParams({page:String(y),limit:String(f)});d&&u.set("q",d),S&&u.set("source",S),fetch(`/api/videos?${u}`).then(g=>g.json()).then(g=>{let{rows:b,total:x,pages:a}=g;l=a,M.innerHTML="",b.forEach(p=>{let I=document.createElement("tr");I.innerHTML=`
              <td>${p.id}</td>
              <td>${p.title||"(no title)"}</td>
              <td>${p.artist||""}</td>
              <td>${p.year||""}</td>
              <td>${p.genre||""}</td>
              <td>${_(p.duration)}</td>
              <td>
                <input type="checkbox" ${p.is_ident?"checked":""} data-id="${p.id}">
              </td>
              <td>${p.source_url?`<a href="${p.source_url}" target="_blank">source</a>`:""}</td>
              <td class="px-3 py-2 flex gap-2">
                <button data-id="${p.id}" class="editBtn px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Edit</button>
                <button data-id="${p.id}" class="deleteBtn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Delete</button>
              </td>
            `,M.appendChild(I),I.querySelector(".editBtn").addEventListener("click",()=>{if(!B||!s||!T||!o)return;B.textContent="Edit Video",s.innerHTML=`
                <div class="space-y-3">
                  <label class="block text-sm font-medium">Title</label>
                  <input id="edit_title" value="${p.title||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Artist</label>
                  <input id="edit_artist" value="${p.artist||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Year</label>
                  <input id="edit_year" value="${p.year||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Genre</label>
                  <input id="edit_genre" value="${p.genre||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="flex items-center gap-2 mt-2">
                    <input id="edit_ident" type="checkbox" ${p.is_ident?"checked":""}> Ident
                  </label>
                  <button id="modalGrab" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">Grab Metadata</button>
                </div>
              `,T.onclick=async()=>{await fetch(`/api/videos/${p.id}/edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:document.getElementById("edit_title").value,artist:document.getElementById("edit_artist").value,year:document.getElementById("edit_year").value,genre:document.getElementById("edit_genre").value,is_ident:document.getElementById("edit_ident").checked})}),N(),k(y)};let P=document.getElementById("modalGrab");P&&(P.onclick=async()=>{let $=new URLSearchParams;$.append("artist",document.getElementById("edit_artist").value),$.append("track",document.getElementById("edit_title").value);let L=await(await fetch("/api/grab",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:$})).json();L.year!==void 0&&(document.getElementById("edit_year").value=L.year),L.genre!==void 0&&(document.getElementById("edit_genre").value=L.genre)}),o.classList.remove("hidden")}),I.querySelector(".deleteBtn").addEventListener("click",()=>{!B||!s||!T||!o||(B.textContent="Delete Video",s.innerHTML=`
                <p class="text-red-400">Are you sure you want to delete:<br>
                <strong>${p.title||"(no title)"}</strong>?</p>
              `,T.onclick=async()=>{await fetch(`/api/videos/${p.id}`,{method:"DELETE"}),N(),k(y)},o.classList.remove("hidden"))})}),M.querySelectorAll("input[type=checkbox]").forEach(p=>{p.addEventListener("change",async()=>{let I=p.dataset.id;await fetch(`/api/videos/${I}/ident`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_ident:p.checked})})})}),A(x,y,l)})}function A(c,u,g){if(!w||!i||!C)return;let b=c===0?0:(u-1)*f+1,x=Math.min(u*f,c);w.textContent=`Showing ${b}\u2013${x} of ${c}`,i.disabled=u<=1,C.disabled=u>=g}function N(){o?.classList.add("hidden")}return{reloadVideos:()=>k(y)}}function Y(M=()=>{}){let y=document.getElementById("addForm"),f=document.getElementById("addStatusText"),l=document.getElementById("addStatusBar"),d=document.getElementById("addStatusLog"),S=document.getElementById("addStatusToggleLog"),w=document.getElementById("addStatusModal"),i=document.getElementById("addStatusClose"),C=document.getElementById("addMeta"),E=document.getElementById("addMetaThumb"),r=document.getElementById("addMetaArtist"),o=document.getElementById("addMetaTrack");if(!y||!f||!l||!d||!w)return;let h=document.getElementById("manualUploadZone"),B=document.getElementById("manualUploadInput");function s(){typeof w.showModal=="function"?w.showModal():(w.style.display="block",w.classList.remove("hidden"))}function T(){typeof w.close=="function"?w.close():(w.style.display="none",w.classList.add("hidden"))}function _(c){f.textContent=c,l.style.width="0%",d.textContent="",d.classList.add("hidden"),S&&(S.textContent="Show log"),C?.classList.add("hidden"),E&&(E.src=""),r&&(r.textContent=""),o&&(o.textContent=""),i&&(i.disabled=!0)}S?.addEventListener("click",()=>{let c=!d.classList.contains("hidden");d.classList.toggle("hidden",c),S.textContent=c?"Show log":"Hide log"}),i&&(i.disabled=!0,i.addEventListener("click",()=>{let c=document.getElementById("url");c&&(c.value=""),T(),M()})),y.addEventListener("submit",async c=>{c.preventDefault();let u=Object.fromEntries(new FormData(y).entries());_("Starting yt-dlp import\u2026"),s();let g=u.url,b=new EventSource(`/api/add-url/stream?url=${encodeURIComponent(g)}`);b.addEventListener("status",x=>{let a=JSON.parse(x.data);f.textContent=a.message}),b.addEventListener("progress",x=>{let a=JSON.parse(x.data);typeof a.percent=="number"&&(l.style.width=`${a.percent}%`,f.textContent=`Downloading\u2026 ${a.percent.toFixed(1)}%`),a.speed&&(f.textContent+=` (${a.speed})`)}),b.addEventListener("log",x=>{let a=JSON.parse(x.data).line;d.textContent+=a+`
`,d.scrollTop=d.scrollHeight;let p=a.match(/\[download\]\s+([\d.]+)%.*?at\s+([^\s]+).*?ETA\s+([0-9:]+)/i);if(p){let I=parseFloat(p[1]),P=p[2],$=p[3];Number.isNaN(I)||(l.style.width=`${I}%`,f.textContent=`Downloading\u2026 ${I.toFixed(1)}% (${P}, ETA ${$})`)}}),b.addEventListener("video",x=>{let a=JSON.parse(x.data);f.textContent=`Added: ${a.artist||""} ${a.title||""}`}),b.addEventListener("meta",x=>{let a=JSON.parse(x.data);a.thumbnail&&E&&(E.src=a.thumbnail),(a.artist||a.uploader)&&(r.textContent=a.artist||a.uploader),(a.track||a.title)&&(o.textContent=a.track||a.title),C?.classList.remove("hidden")}),b.addEventListener("done",()=>{f.textContent="Import complete \u{1F389}",l.style.width="100%",b.close(),y.reset(),i&&(i.disabled=!1),M()}),b.addEventListener("error",x=>{try{let a=JSON.parse(x.data);f.textContent="Error: "+a.message}catch{f.textContent="Import failed"}b.close(),i&&(i.disabled=!1)})});let k=c=>!!c&&(c.name&&c.name.toLowerCase().endsWith(".mp4")||c.type==="video/mp4");function A(c,u){let g=new FormData;g.append("video",c);let b=new XMLHttpRequest;b.open("POST","/api/manual-upload"),b.upload.onprogress=x=>{if(!x.lengthComputable)return;let a=x.loaded/x.total*100;l.style.width=`${a}%`,f.textContent=`Uploading\u2026 ${a.toFixed(1)}%`},b.onload=()=>{if(b.status>=200&&b.status<300){l.style.width="100%",u(!0);return}let x="Upload failed";try{let a=JSON.parse(b.responseText);a.error&&(x=a.error)}catch{}u(!1,x)},b.onerror=()=>{u(!1,"Upload failed")},b.send(g)}function N(c){if(!c?.length)return;let u=Array.from(c),g=u.filter(k),b=u.filter(I=>!k(I));if(!g.length){window.alert("Only MP4 files are supported for manual upload.");return}b.length&&window.alert(`Skipped non-MP4 files:
${b.map(I=>I.name||"Unnamed").join(", ")}`);let x=g.length,a=0;s();let p=()=>{if(a>=x){f.textContent="Upload complete \u{1F389}",l.style.width="100%",i&&(i.disabled=!1),B&&(B.value=""),M();return}let I=g[a];_(`Uploading (${a+1}/${x}) ${I.name}`),A(I,(P,$)=>{P?(M(),a+=1,p()):(f.textContent=$||`Upload failed for ${I.name}`,i&&(i.disabled=!1))})};p()}if(h&&B){let c=u=>{h.style.borderColor=u?"rgba(216, 180, 254, 0.9)":"",h.style.backgroundColor=u?"rgba(76, 29, 149, 0.2)":""};["dragenter","dragover"].forEach(u=>{h.addEventListener(u,g=>{g.preventDefault(),g.stopPropagation(),c(!0)})}),["dragleave","drop"].forEach(u=>{h.addEventListener(u,g=>{g.preventDefault(),g.stopPropagation(),c(!1)})}),h.addEventListener("drop",u=>{let g=u.dataTransfer?.files;g?.length&&N(g)}),h.addEventListener("click",()=>{B.click()}),B.addEventListener("change",()=>{B.files?.length&&N(B.files)})}}function Z(){let M=document.getElementById("usersPage"),y=document.getElementById("userForm"),f=document.getElementById("userUsername"),l=document.getElementById("userPassword"),d=document.getElementById("userFormAlert"),S=document.getElementById("userTableBody"),w=document.getElementById("userCount"),i=document.getElementById("userEditDialog"),C=document.getElementById("userEditForm"),E=document.getElementById("editUserId"),r=document.getElementById("editUsername"),o=document.getElementById("editPassword"),h=document.getElementById("userEditAlert"),B=document.getElementById("userEditCancel"),s=document.getElementById("userConfirmDialog"),T=document.getElementById("userConfirmText"),_=document.getElementById("userConfirmCancel"),k=document.getElementById("userConfirmDelete"),A=M?.dataset?.currentUser||"",N=null;if(!y||!f||!l||!S)return;let c=($,m="success")=>{d&&(d.textContent=$,d.classList.remove("hidden"),d.classList.toggle("bg-green-500/10",m==="success"),d.classList.toggle("border-green-500/40",m==="success"),d.classList.toggle("text-green-200",m==="success"),d.classList.toggle("bg-red-500/10",m==="error"),d.classList.toggle("border-red-500/40",m==="error"),d.classList.toggle("text-red-200",m==="error"))},u=()=>{d&&(d.classList.add("hidden"),d.textContent="",d.classList.remove("bg-green-500/10","border-green-500/40","text-green-200","bg-red-500/10","border-red-500/40","text-red-200"))},g=($,m="success")=>{h&&(h.textContent=$,h.classList.remove("hidden"),h.classList.toggle("bg-green-500/10",m==="success"),h.classList.toggle("border-green-500/40",m==="success"),h.classList.toggle("text-green-200",m==="success"),h.classList.toggle("bg-red-500/10",m==="error"),h.classList.toggle("border-red-500/40",m==="error"),h.classList.toggle("text-red-200",m==="error"))},b=()=>{h&&(h.classList.add("hidden"),h.textContent="",h.classList.remove("bg-green-500/10","border-green-500/40","text-green-200","bg-red-500/10","border-red-500/40","text-red-200"))},x=$=>{!i||!C||!E||!r||!o||(E.value=String($.id),r.value=$.username,o.value="",b(),typeof i.showModal=="function"?i.showModal():i.style.display="block")},a=()=>{i&&(typeof i.close=="function"?i.close():i.style.display="none")};B?.addEventListener("click",()=>{a()});let p=($,m)=>{!s||!T||!k||!_||(T.textContent=$,N=m,typeof s.showModal=="function"?s.showModal():s.style.display="block")},I=()=>{N=null,s&&(typeof s.close=="function"?s.close():s.style.display="none")};_?.addEventListener("click",()=>I()),k?.addEventListener("click",()=>{N&&N(),I()});async function P(){try{let m=await(await fetch("/api/users")).json();S.innerHTML="",m.length?m.forEach(L=>{let D=document.createElement("tr"),O=A&&L.username===A;D.innerHTML=`
              <td class="px-4 py-3 font-mono text-xs text-gray-400">#${L.id}</td>
              <td class="px-4 py-3 font-semibold">${L.username}</td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <button
                    data-id="${L.id}"
                    data-username="${L.username}"
                    class="user-edit-btn px-3 py-1.5 rounded-xl border border-white/15 text-xs text-purple-100 hover:bg-white/10 transition">
                    Edit
                  </button>
                  <button
                    data-id="${L.id}"
                    class="user-delete-btn px-3 py-1.5 rounded-xl border border-red-400/40 text-xs text-red-200 hover:bg-red-500/20 transition ${O?"opacity-40 cursor-not-allowed":""}"
                    ${O?"disabled":""}>
                    Delete
                  </button>
                </div>
              </td>
            `,S.appendChild(D);let q=D.querySelector(".user-edit-btn"),U=D.querySelector(".user-delete-btn");q?.addEventListener("click",()=>x(L)),U?.addEventListener("click",()=>{p(`Are you sure you want to delete "${L.username}"? This cannot be undone.`,async()=>{if(U){U.disabled=!0;try{let J=await fetch(`/api/users/${L.id}`,{method:"DELETE"}),j=await J.json();!J.ok||!j.ok?alert(j.error||"Failed to delete user"):P()}catch{alert("Failed to delete user")}finally{U.disabled=!1}}})})}):S.innerHTML=`
            <tr>
              <td colspan="3" class="px-4 py-6 text-center text-gray-400 text-sm">
                No users yet. Create one on the left.
              </td>
            </tr>
          `,w&&(w.textContent=`${m.length} user${m.length===1?"":"s"}`)}catch{S.innerHTML=`
          <tr>
            <td colspan="3" class="px-4 py-6 text-center text-red-300 text-sm">
              Failed to load users.
            </td>
          </tr>
        `}}y.addEventListener("submit",async $=>{$.preventDefault(),u();let m=y.querySelector("button[type=submit]");m&&(m.disabled=!0);try{let L=await fetch("/api/add-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:f.value.trim(),password:l.value})}),D=await L.json();!L.ok||!D.ok?c(D.error||"Failed to add user","error"):(c("User created successfully.","success"),y.reset(),P())}catch{c("Failed to add user","error")}finally{m&&(m.disabled=!1)}}),C?.addEventListener("submit",async $=>{if($.preventDefault(),!E||!r||!o)return;b();let m=C.querySelector("button[type=submit]");m&&(m.disabled=!0);try{let L={username:r.value.trim(),password:o.value},D=await fetch(`/api/users/${E.value}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)}),O=await D.json();!D.ok||!O.ok?g(O.error||"Failed to update user","error"):(g("User updated.","success"),P(),setTimeout(()=>{a()},500))}catch{g("Failed to update user","error")}finally{m&&(m.disabled=!1)}}),P()}function z(){let y=document.getElementById("playlistId")?.dataset?.playlistId,f=document.getElementById("playlistItems"),l=document.getElementById("videoLibrary");if(!y||!f||!l)return;let d=document.getElementById("playlistPicker"),S=document.getElementById("playlistMeta"),w=document.getElementById("playlistCount"),i=document.getElementById("playlistStatus"),C=document.getElementById("playlistSave"),E=document.getElementById("librarySearch"),r=document.getElementById("playlistDaysForm"),o=document.getElementById("playlistDaysStatus"),h=document.getElementById("playlistDaysCaption"),B=r?.querySelectorAll("[data-day-checkbox]"),s=null,T=null,_="",k=null,A=!1,N=[],c=t=>{let e=Number(t);return Number.isFinite(e)&&e>=0?e:0},u=t=>{let e=Math.round(Number(t)||0),n=Math.floor(e/3600),v=Math.floor(e%3600/60),F=e%60;return n>0?`${n}:${String(v).padStart(2,"0")}:${String(F).padStart(2,"0")}`:`${v}:${String(F).padStart(2,"0")}`},g=["sun","mon","tue","wed","thu","fri","sat"],b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],x=t=>{let e=(t||"").split(",").map(n=>n.trim().toLowerCase()).filter(Boolean);return e.length?(e.sort((n,v)=>g.indexOf(n)-g.indexOf(v)),e.map(n=>{let v=g.indexOf(n);return v>=0?b[v]:n}).join(", ")):"Runs daily"};D(),O(),q(),d?.addEventListener("change",t=>{let e=t.target.value;e&&Number(e)!==Number(y)&&(window.location.href=`/playlists/${e}`)}),E?.addEventListener("input",()=>{_=E.value.trim(),clearTimeout(k),k=setTimeout(()=>q(_),250)}),C?.addEventListener("click",()=>R(!0)),r?.addEventListener("submit",async t=>{t.preventDefault();let e=[...B||[]].filter(n=>n.checked).map(n=>n.value);o&&(o.textContent="Saving\u2026");try{if(!(await fetch(`/api/playlists/${y}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({active_days:e})})).ok)throw new Error("Failed to save schedule");o&&(o.textContent="Saved schedule."),D()}catch(n){o&&(o.textContent=n.message||"Failed to save schedule.")}finally{o&&setTimeout(()=>{o.textContent=""},2500)}});function a(t,e=!0){!i||!t||(i.textContent=t,e&&setTimeout(()=>{i.textContent===t&&(i.textContent="")},2500))}function p(t){if(!B)return;let e=(t||"").split(",").map(n=>n.trim().toLowerCase()).filter(Boolean);B.forEach(n=>{n.checked=e.includes(n.value)}),h&&(h.textContent=e.length?`Active on ${x(t)}`:"Runs daily by default.")}function I(){f.querySelectorAll("[data-placeholder]").forEach(t=>t.remove())}function P(){if(f.querySelector("[data-item-id]")||f.querySelector("[data-placeholder]"))return;let t=document.createElement("li");t.dataset.placeholder="true",t.className="text-center text-gray-500 text-sm py-10",t.textContent="Drop videos here to start building your schedule.",f.appendChild(t)}function $(t,e=0){if(!w)return;let n=u(e);w.textContent=`${t} item${t===1?"":"s"} \u2022 ${n}`}function m(){let t=[...f.querySelectorAll("[data-item-id]")],e=t.reduce((n,v)=>n+(Number(v.dataset.duration||0)||0),0);$(t.length,e),t.length||P()}function L(){[...f.querySelectorAll("[data-item-id]")].forEach((t,e)=>{let n=t.querySelector(".slot-label");n&&(n.textContent=`Slot ${e+1}`)})}async function D(){try{let e=await(await fetch("/api/playlists")).json();N=e,d&&(d.innerHTML="",e.forEach(v=>{let F=document.createElement("option");F.value=v.id,F.textContent=v.name||`Playlist #${v.id}`,Number(v.id)===Number(y)&&(F.selected=!0),d.appendChild(F)}));let n=e.find(v=>Number(v.id)===Number(y));S&&(S.textContent=n?.name||`Playlist #${y}`),p(n?.active_days||"")}catch(t){console.error("Failed to load playlists",t)}}async function O(){try{let e=await(await fetch(`/api/playlists/${y}/items`)).json();f.innerHTML="",e.length?e.forEach(n=>f.appendChild(J(n))):P(),L(),m(),K()}catch(t){console.error("Failed to load playlist items",t)}}async function q(t=""){try{l.innerHTML='<div class="text-center py-6 text-gray-400 text-sm">Loading library\u2026</div>';let e=new URLSearchParams({limit:"100"});t&&e.set("q",t);let v=await(await fetch(`/api/videos?${e.toString()}`)).json(),F=Array.isArray(v)?v:v.rows||[];l.innerHTML="",F.length?F.forEach(te=>l.appendChild(U(te))):l.innerHTML='<div class="text-center py-10 text-gray-500 text-sm">No videos match that search.</div>',X()}catch(e){console.error("Failed to load library",e),l.innerHTML='<div class="text-center py-6 text-red-400 text-sm">Failed to load library.</div>'}}function U(t){let e=document.createElement("li");e.dataset.videoId=t.id,e.className="border border-white/10 rounded-2xl px-4 py-3 bg-white/5 backdrop-blur-sm cursor-grab hover:border-purple-400/40 transition flex items-center justify-between gap-3";let n=c(t.duration),v=u(n);return e.innerHTML=`
        <div>
          <p class="font-semibold text-white">${t.artist||"Unknown"} <span class="text-gray-400">\u2014 ${t.title||"Untitled"}</span></p>
          <p class="text-xs text-gray-400 uppercase tracking-wide">${t.genre||"Genre"} \u2022 ${t.year||"Year"} \u2022 ${v}</p>
        </div>
        <span class="text-xs text-gray-500">Drag</span>
      `,e}function J(t){let e=document.createElement("li");return j(e,t),V(e),e}function j(t,e){let n=c(e.duration);t.dataset.itemId=e.id,t.dataset.videoId=e.video_id,t.dataset.duration=n,t.className="border border-white/10 rounded-2xl px-4 py-3 bg-gradient-to-r from-purple-600/10 to-indigo-600/5 backdrop-blur flex items-center justify-between gap-4";let v=u(n);t.innerHTML=`
        <div>
          <p class="font-semibold text-white">${e.artist||"Unknown"} <span class="text-gray-300">\u2014 ${e.title||"Untitled"}</span></p>
          <p class="text-xs text-gray-400 uppercase tracking-wide">${e.genre||"Genre"} \u2022 ${v}</p>
        </div>
        <div class="flex items-center gap-3 text-xs text-gray-400">
          <span class="slot-label hidden sm:inline">Slot ${e.position||"\u2014"}</span>
          <span class="drag-handle cursor-grab text-lg leading-none text-white/60 hover:text-white">\u22EE\u22EE</span>
          <button class="playlist-item-delete px-2 py-1 rounded-lg border border-red-400/40 text-red-200 hover:bg-red-500/20 transition">
            Remove
          </button>
        </div>
      `}function V(t){t.querySelector(".playlist-item-delete")?.addEventListener("click",()=>{ee(t.dataset.itemId,t)})}function X(){window.Sortable&&(s&&s.destroy(),s=new Sortable(l,{group:{name:"playlist-videos",pull:"clone",put:!1},sort:!1,animation:150,ghostClass:"opacity-50"}))}function K(){window.Sortable&&(T&&T.destroy(),T=new Sortable(f,{group:{name:"playlist-videos",pull:!0,put:!0},animation:200,ghostClass:"opacity-50",handle:".drag-handle",onAdd(t){let e=t.item.dataset.videoId;e&&(I(),!t.item.dataset.itemId&&Q(e,t.item))},onUpdate(){R()}}))}async function Q(t,e){try{let n=await fetch(`/api/playlists/${y}/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({video_id:Number(t)})}),v=await n.json();if(!n.ok||!v.ok||!v.item)throw new Error(v.error||"Failed to add video");j(e,v.item),V(e),L(),m(),await R(),a("Added video to playlist.")}catch(n){console.error(n),e.remove(),m(),alert(n.message||"Failed to add video to playlist")}}async function ee(t,e){if(t){e.classList.add("opacity-50");try{if(!(await fetch(`/api/playlists/${y}/items/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to remove item");e.remove(),L(),m(),a("Removed item from playlist.")}catch(n){e.classList.remove("opacity-50"),alert(n.message||"Failed to remove item")}}}async function R(t=!1){if(A)return;let e=[...f.querySelectorAll("[data-item-id]")].map(n=>Number(n.dataset.itemId));if(e.length){A=!0;try{if(!(await fetch(`/api/playlists/${y}/order`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:e})})).ok)throw new Error("Failed to save order");L(),m(),t&&a("Playlist order saved.")}catch(n){console.error(n),alert(n.message||"Failed to save playlist order")}finally{A=!1}}}}})();})();
