(()=>{(()=>{let q=window.location.pathname||"/";document.addEventListener("DOMContentLoaded",()=>{if(q==="/"&&G(),q.startsWith("/media")){let M=V();W(M?.reloadVideos)}q.startsWith("/users")&&Y(),q.startsWith("/playlists/")&&Z()});function G(){M(),y(),f();function M(){let l=document.querySelector("#videosTable tbody"),d=document.getElementById("modalOverlay"),S=document.getElementById("modalCancel"),w=document.getElementById("modalTitle"),i=document.getElementById("modalContent"),C=document.getElementById("modalConfirm");if(!l||!d||!w||!i||!C)return;async function E(){let B=await(await fetch("/api/videos")).json();l.innerHTML="",B.forEach(o=>{let T=document.createElement("tr");T.innerHTML=`
            <td>${o.id}</td>
            <td>${o.title||"(no title)"}</td>
            <td>${o.artist||""}</td>
            <td>${o.year||""}</td>
            <td>${o.genre||""}</td>
            <td>
              <input type="checkbox" ${o.is_ident?"checked":""} data-id="${o.id}">
            </td>
            <td>${o.source_url?`<a href="${o.source_url}" target="_blank">source</a>`:""}</td>
            <td class="px-3 py-2 flex gap-2">
              <button data-id="${o.id}" class="editBtn px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Edit</button>
              <button data-id="${o.id}" class="deleteBtn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Delete</button>
            </td>
          `,l.appendChild(T),T.querySelector(".editBtn").addEventListener("click",()=>{w.textContent="Edit Video",i.innerHTML=`
              <div class="space-y-3">
                <label class="block text-sm font-medium">Title</label>
                <input id="edit_title" value="${o.title||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Artist</label>
                <input id="edit_artist" value="${o.artist||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Year</label>
                <input id="edit_year" value="${o.year||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="block text-sm font-medium">Genre</label>
                <input id="edit_genre" value="${o.genre||""}"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                <label class="flex items-center gap-2 mt-2">
                  <input id="edit_ident" type="checkbox" ${o.is_ident?"checked":""}>
                  Ident
                </label>
              </div>
            `,C.onclick=async()=>{await fetch(`/api/videos/${o.id}/edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:document.getElementById("edit_title").value,artist:document.getElementById("edit_artist").value,year:document.getElementById("edit_year").value,genre:document.getElementById("edit_genre").value,is_ident:document.getElementById("edit_ident").checked})}),a(),E()},r()}),T.querySelector(".deleteBtn").addEventListener("click",()=>{w.textContent="Delete Video",i.innerHTML=`
              <p class="text-red-400">Are you sure you want to delete:<br>
              <strong>${o.title||"(no title)"}</strong>?</p>
            `,C.onclick=async()=>{await fetch(`/api/videos/${o.id}`,{method:"DELETE"}),a(),E()},r()})}),l.querySelectorAll("input[type=checkbox]").forEach(o=>{o.addEventListener("change",async()=>{let T=o.dataset.id;await fetch(`/api/videos/${T}/ident`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_ident:o.checked})})})})}function r(){d.classList.remove("hidden")}function a(){d.classList.add("hidden")}S?.addEventListener("click",a),E()}function y(){let l=document.getElementById("nowPlaying");if(!l)return;async function d(){let w=await(await fetch("/api/now-playing")).json();l.textContent=JSON.stringify(w,null,2)}d(),setInterval(d,5e3)}function f(){let l=document.getElementById("playlists"),d=document.getElementById("newPlaylistForm");if(!l&&!d)return;let S=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],w=C=>{let E=(C||"").split(",").map(a=>a.trim().toLowerCase()).filter(Boolean);if(!E.length)return"Runs daily";let r=["sun","mon","tue","wed","thu","fri","sat"];return E.sort((a,h)=>r.indexOf(a)-r.indexOf(h)),E.map(a=>{let h=r.indexOf(a);return h>=0?S[h]:a}).join(", ")};async function i(){if(!l)return;let E=await(await fetch("/api/playlists")).json();l.innerHTML="",E.forEach(r=>{let a=document.createElement("div");a.className="flex flex-col gap-3 rounded-2xl border border-white/10 bg-black/30 p-4 md:flex-row md:items-center md:justify-between",a.innerHTML=`
            <div>
              <p class="text-sm font-semibold text-white">${r.name}</p>
              <p class="text-xs text-gray-400">${r.description||"No description"}</p>
              <p class="text-[0.7rem] text-gray-500 mt-1">${w(r.active_days)}</p>
              ${r.is_active?'<span class="text-xs text-emerald-300 inline-flex items-center gap-1 mt-1">\u25CF Active</span>':""}
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <a href="/playlists/${r.id}" class="px-3 py-1.5 rounded-xl border border-white/15 text-purple-100 hover:bg-purple-900/30 transition">Open</a>
              <button data-id="${r.id}" class="activate-btn px-3 py-1.5 rounded-xl border border-emerald-400/40 text-emerald-200 hover:bg-emerald-500/20 transition" ${r.is_active?"disabled":""}>
                Set active
              </button>
              <button data-id="${r.id}" class="disable-btn px-3 py-1.5 rounded-xl border border-yellow-400/40 text-yellow-200 hover:bg-yellow-500/20 transition" ${r.is_active?"":"disabled"}>
                Disable
              </button>
              <button data-id="${r.id}" class="delete-btn px-3 py-1.5 rounded-xl border border-red-400/40 text-red-200 hover:bg-red-500/20 transition">
                Delete
              </button>
            </div>
          `,l.appendChild(a)}),l.querySelectorAll(".activate-btn").forEach(r=>{r.addEventListener("click",async()=>{let a=r.dataset.id;await fetch(`/api/playlists/${a}/activate`,{method:"POST"}),i()})}),l.querySelectorAll(".disable-btn").forEach(r=>{r.addEventListener("click",async()=>{let a=r.dataset.id;await fetch(`/api/playlists/${a}/deactivate`,{method:"POST"}),i()})}),l.querySelectorAll(".delete-btn").forEach(r=>{r.addEventListener("click",async()=>{let a=r.dataset.id;confirm("Delete this playlist? This cannot be undone.")&&(await fetch(`/api/playlists/${a}`,{method:"DELETE"}),i())})})}d?.addEventListener("submit",async C=>{C.preventDefault();let E=new FormData(d),r={name:E.get("name"),description:E.get("description"),active_days:E.getAll("days")};await fetch("/api/playlists",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),d.reset(),i()}),i()}}function V(){let M=document.getElementById("videosTableBody");if(!M)return null;let y=1,f=25,l=1,d="",S="",w=document.getElementById("videoPageInfo"),i=document.getElementById("videoPrev"),C=document.getElementById("videoNext"),E=document.getElementById("videoSearch"),r=document.getElementById("videoSourceFilter"),a=document.getElementById("modalOverlay"),h=document.getElementById("modalCancel"),B=document.getElementById("modalTitle"),o=document.getElementById("modalContent"),T=document.getElementById("modalConfirm");E?.addEventListener("input",()=>{d=E.value.trim(),y=1,k(1)}),r?.addEventListener("change",()=>{S=r.value,y=1,k(1)}),i?.addEventListener("click",()=>{y>1&&k(y-1)}),C?.addEventListener("click",()=>{y<l&&k(y+1)}),h?.addEventListener("click",()=>a?.classList.add("hidden")),k();function A(c){let u=Math.round(Number(c)||0);if(u<=0)return"\u2014";let x=Math.floor(u/3600),b=Math.floor(u%3600/60),g=u%60;return x>0?`${x}:${String(b).padStart(2,"0")}:${String(g).padStart(2,"0")}`:`${b}:${String(g).padStart(2,"0")}`}function k(c=1){y=c;let u=new URLSearchParams({page:String(y),limit:String(f)});d&&u.set("q",d),S&&u.set("source",S),fetch(`/api/videos?${u}`).then(x=>x.json()).then(x=>{let{rows:b,total:g,pages:s}=x;l=s,M.innerHTML="",b.forEach(m=>{let $=document.createElement("tr");$.innerHTML=`
              <td>${m.id}</td>
              <td>${m.title||"(no title)"}</td>
              <td>${m.artist||""}</td>
              <td>${m.year||""}</td>
              <td>${m.genre||""}</td>
              <td>${A(m.duration)}</td>
              <td>
                <input type="checkbox" ${m.is_ident?"checked":""} data-id="${m.id}">
              </td>
              <td>${m.source_url?`<a href="${m.source_url}" target="_blank">source</a>`:""}</td>
              <td class="px-3 py-2 flex gap-2">
                <button data-id="${m.id}" class="editBtn px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Edit</button>
                <button data-id="${m.id}" class="deleteBtn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Delete</button>
              </td>
            `,M.appendChild($),$.querySelector(".editBtn").addEventListener("click",()=>{if(!B||!o||!T||!a)return;B.textContent="Edit Video",o.innerHTML=`
                <div class="space-y-3">
                  <label class="block text-sm font-medium">Title</label>
                  <input id="edit_title" value="${m.title||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Artist</label>
                  <input id="edit_artist" value="${m.artist||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Year</label>
                  <input id="edit_year" value="${m.year||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="block text-sm font-medium">Genre</label>
                  <input id="edit_genre" value="${m.genre||""}" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" />
                  <label class="flex items-center gap-2 mt-2">
                    <input id="edit_ident" type="checkbox" ${m.is_ident?"checked":""}> Ident
                  </label>
                  <button id="modalGrab" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">Grab Metadata</button>
                </div>
              `,T.onclick=async()=>{await fetch(`/api/videos/${m.id}/edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:document.getElementById("edit_title").value,artist:document.getElementById("edit_artist").value,year:document.getElementById("edit_year").value,genre:document.getElementById("edit_genre").value,is_ident:document.getElementById("edit_ident").checked})}),D(),k(y)};let P=document.getElementById("modalGrab");P&&(P.onclick=async()=>{let v=new URLSearchParams;v.append("artist",document.getElementById("edit_artist").value),v.append("track",document.getElementById("edit_title").value);let I=await(await fetch("/api/grab",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:v})).json();I.year!==void 0&&(document.getElementById("edit_year").value=I.year),I.genre!==void 0&&(document.getElementById("edit_genre").value=I.genre)}),a.classList.remove("hidden")}),$.querySelector(".deleteBtn").addEventListener("click",()=>{!B||!o||!T||!a||(B.textContent="Delete Video",o.innerHTML=`
                <p class="text-red-400">Are you sure you want to delete:<br>
                <strong>${m.title||"(no title)"}</strong>?</p>
              `,T.onclick=async()=>{await fetch(`/api/videos/${m.id}`,{method:"DELETE"}),D(),k(y)},a.classList.remove("hidden"))})}),M.querySelectorAll("input[type=checkbox]").forEach(m=>{m.addEventListener("change",async()=>{let $=m.dataset.id;await fetch(`/api/videos/${$}/ident`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_ident:m.checked})})})}),N(g,y,l)})}function N(c,u,x){if(!w||!i||!C)return;let b=c===0?0:(u-1)*f+1,g=Math.min(u*f,c);w.textContent=`Showing ${b}\u2013${g} of ${c}`,i.disabled=u<=1,C.disabled=u>=x}function D(){a?.classList.add("hidden")}return{reloadVideos:()=>k(y)}}function W(M=()=>{}){let y=document.getElementById("addForm"),f=document.getElementById("addStatusText"),l=document.getElementById("addStatusBar"),d=document.getElementById("addStatusLog"),S=document.getElementById("addStatusToggleLog"),w=document.getElementById("addStatusModal"),i=document.getElementById("addStatusClose"),C=document.getElementById("addMeta"),E=document.getElementById("addMetaThumb"),r=document.getElementById("addMetaArtist"),a=document.getElementById("addMetaTrack");if(!y||!f||!l||!d||!w)return;let h=document.getElementById("manualUploadZone"),B=document.getElementById("manualUploadInput");function o(){typeof w.showModal=="function"?w.showModal():(w.style.display="block",w.classList.remove("hidden"))}function T(){typeof w.close=="function"?w.close():(w.style.display="none",w.classList.add("hidden"))}function A(c){f.textContent=c,l.style.width="0%",d.textContent="",d.classList.add("hidden"),S&&(S.textContent="Show log"),C?.classList.add("hidden"),E&&(E.src=""),r&&(r.textContent=""),a&&(a.textContent=""),i&&(i.disabled=!0)}S?.addEventListener("click",()=>{let c=!d.classList.contains("hidden");d.classList.toggle("hidden",c),S.textContent=c?"Show log":"Hide log"}),i&&(i.disabled=!0,i.addEventListener("click",()=>{let c=document.getElementById("url");c&&(c.value=""),T(),M()})),y.addEventListener("submit",async c=>{c.preventDefault();let u=Object.fromEntries(new FormData(y).entries());A("Starting yt-dlp import\u2026"),o();let x=u.url,b=new EventSource(`/api/add-url/stream?url=${encodeURIComponent(x)}`);b.addEventListener("status",g=>{let s=JSON.parse(g.data);f.textContent=s.message}),b.addEventListener("progress",g=>{let s=JSON.parse(g.data);typeof s.percent=="number"&&(l.style.width=`${s.percent}%`,f.textContent=`Downloading\u2026 ${s.percent.toFixed(1)}%`),s.speed&&(f.textContent+=` (${s.speed})`)}),b.addEventListener("log",g=>{let s=JSON.parse(g.data).line;d.textContent+=s+`
`,d.scrollTop=d.scrollHeight;let m=s.match(/\[download\]\s+([\d.]+)%.*?at\s+([^\s]+).*?ETA\s+([0-9:]+)/i);if(m){let $=parseFloat(m[1]),P=m[2],v=m[3];Number.isNaN($)||(l.style.width=`${$}%`,f.textContent=`Downloading\u2026 ${$.toFixed(1)}% (${P}, ETA ${v})`)}}),b.addEventListener("video",g=>{let s=JSON.parse(g.data);f.textContent=`Added: ${s.artist||""} ${s.title||""}`}),b.addEventListener("meta",g=>{let s=JSON.parse(g.data);s.thumbnail&&E&&(E.src=s.thumbnail),(s.artist||s.uploader)&&(r.textContent=s.artist||s.uploader),(s.track||s.title)&&(a.textContent=s.track||s.title),C?.classList.remove("hidden")}),b.addEventListener("done",()=>{f.textContent="Import complete \u{1F389}",l.style.width="100%",b.close(),y.reset(),i&&(i.disabled=!1),M()}),b.addEventListener("error",g=>{try{let s=JSON.parse(g.data);f.textContent="Error: "+s.message}catch{f.textContent="Import failed"}b.close(),i&&(i.disabled=!1)})});let k=c=>!!c&&(c.name&&c.name.toLowerCase().endsWith(".mp4")||c.type==="video/mp4");function N(c,u){let x=new FormData;x.append("video",c);let b=new XMLHttpRequest;b.open("POST","/api/manual-upload"),b.upload.onprogress=g=>{if(!g.lengthComputable)return;let s=g.loaded/g.total*100;l.style.width=`${s}%`,f.textContent=`Uploading\u2026 ${s.toFixed(1)}%`},b.onload=()=>{if(b.status>=200&&b.status<300){l.style.width="100%",u(!0);return}let g="Upload failed";try{let s=JSON.parse(b.responseText);s.error&&(g=s.error)}catch{}u(!1,g)},b.onerror=()=>{u(!1,"Upload failed")},b.send(x)}function D(c){if(!c?.length)return;let u=Array.from(c),x=u.filter(k),b=u.filter($=>!k($));if(!x.length){window.alert("Only MP4 files are supported for manual upload.");return}b.length&&window.alert(`Skipped non-MP4 files:
${b.map($=>$.name||"Unnamed").join(", ")}`);let g=x.length,s=0;o();let m=()=>{if(s>=g){f.textContent="Upload complete \u{1F389}",l.style.width="100%",i&&(i.disabled=!1),B&&(B.value=""),M();return}let $=x[s];A(`Uploading (${s+1}/${g}) ${$.name}`),N($,(P,v)=>{P?(M(),s+=1,m()):(f.textContent=v||`Upload failed for ${$.name}`,i&&(i.disabled=!1))})};m()}if(h&&B){let c=u=>{h.style.borderColor=u?"rgba(216, 180, 254, 0.9)":"",h.style.backgroundColor=u?"rgba(76, 29, 149, 0.2)":""};["dragenter","dragover"].forEach(u=>{h.addEventListener(u,x=>{x.preventDefault(),x.stopPropagation(),c(!0)})}),["dragleave","drop"].forEach(u=>{h.addEventListener(u,x=>{x.preventDefault(),x.stopPropagation(),c(!1)})}),h.addEventListener("drop",u=>{let x=u.dataTransfer?.files;x?.length&&D(x)}),h.addEventListener("click",()=>{B.click()}),B.addEventListener("change",()=>{B.files?.length&&D(B.files)})}}function Y(){let M=document.getElementById("usersPage"),y=document.getElementById("userForm"),f=document.getElementById("userUsername"),l=document.getElementById("userPassword"),d=document.getElementById("userFormAlert"),S=document.getElementById("userTableBody"),w=document.getElementById("userCount"),i=document.getElementById("userEditDialog"),C=document.getElementById("userEditForm"),E=document.getElementById("editUserId"),r=document.getElementById("editUsername"),a=document.getElementById("editPassword"),h=document.getElementById("userEditAlert"),B=document.getElementById("userEditCancel"),o=document.getElementById("userConfirmDialog"),T=document.getElementById("userConfirmText"),A=document.getElementById("userConfirmCancel"),k=document.getElementById("userConfirmDelete"),N=M?.dataset?.currentUser||"",D=null;if(!y||!f||!l||!S)return;let c=(v,p="success")=>{d&&(d.textContent=v,d.classList.remove("hidden"),d.classList.toggle("bg-green-500/10",p==="success"),d.classList.toggle("border-green-500/40",p==="success"),d.classList.toggle("text-green-200",p==="success"),d.classList.toggle("bg-red-500/10",p==="error"),d.classList.toggle("border-red-500/40",p==="error"),d.classList.toggle("text-red-200",p==="error"))},u=()=>{d&&(d.classList.add("hidden"),d.textContent="",d.classList.remove("bg-green-500/10","border-green-500/40","text-green-200","bg-red-500/10","border-red-500/40","text-red-200"))},x=(v,p="success")=>{h&&(h.textContent=v,h.classList.remove("hidden"),h.classList.toggle("bg-green-500/10",p==="success"),h.classList.toggle("border-green-500/40",p==="success"),h.classList.toggle("text-green-200",p==="success"),h.classList.toggle("bg-red-500/10",p==="error"),h.classList.toggle("border-red-500/40",p==="error"),h.classList.toggle("text-red-200",p==="error"))},b=()=>{h&&(h.classList.add("hidden"),h.textContent="",h.classList.remove("bg-green-500/10","border-green-500/40","text-green-200","bg-red-500/10","border-red-500/40","text-red-200"))},g=v=>{!i||!C||!E||!r||!a||(E.value=String(v.id),r.value=v.username,a.value="",b(),typeof i.showModal=="function"?i.showModal():i.style.display="block")},s=()=>{i&&(typeof i.close=="function"?i.close():i.style.display="none")};B?.addEventListener("click",()=>{s()});let m=(v,p)=>{!o||!T||!k||!A||(T.textContent=v,D=p,typeof o.showModal=="function"?o.showModal():o.style.display="block")},$=()=>{D=null,o&&(typeof o.close=="function"?o.close():o.style.display="none")};A?.addEventListener("click",()=>$()),k?.addEventListener("click",()=>{D&&D(),$()});async function P(){try{let p=await(await fetch("/api/users")).json();S.innerHTML="",p.length?p.forEach(I=>{let _=document.createElement("tr"),O=N&&I.username===N;_.innerHTML=`
              <td class="px-4 py-3 font-mono text-xs text-gray-400">#${I.id}</td>
              <td class="px-4 py-3 font-semibold">${I.username}</td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <button
                    data-id="${I.id}"
                    data-username="${I.username}"
                    class="user-edit-btn px-3 py-1.5 rounded-xl border border-white/15 text-xs text-purple-100 hover:bg-white/10 transition">
                    Edit
                  </button>
                  <button
                    data-id="${I.id}"
                    class="user-delete-btn px-3 py-1.5 rounded-xl border border-red-400/40 text-xs text-red-200 hover:bg-red-500/20 transition ${O?"opacity-40 cursor-not-allowed":""}"
                    ${O?"disabled":""}>
                    Delete
                  </button>
                </div>
              </td>
            `,S.appendChild(_);let J=_.querySelector(".user-edit-btn"),U=_.querySelector(".user-delete-btn");J?.addEventListener("click",()=>g(I)),U?.addEventListener("click",()=>{m(`Are you sure you want to delete "${I.username}"? This cannot be undone.`,async()=>{if(U){U.disabled=!0;try{let j=await fetch(`/api/users/${I.id}`,{method:"DELETE"}),H=await j.json();!j.ok||!H.ok?alert(H.error||"Failed to delete user"):P()}catch{alert("Failed to delete user")}finally{U.disabled=!1}}})})}):S.innerHTML=`
            <tr>
              <td colspan="3" class="px-4 py-6 text-center text-gray-400 text-sm">
                No users yet. Create one on the left.
              </td>
            </tr>
          `,w&&(w.textContent=`${p.length} user${p.length===1?"":"s"}`)}catch{S.innerHTML=`
          <tr>
            <td colspan="3" class="px-4 py-6 text-center text-red-300 text-sm">
              Failed to load users.
            </td>
          </tr>
        `}}y.addEventListener("submit",async v=>{v.preventDefault(),u();let p=y.querySelector("button[type=submit]");p&&(p.disabled=!0);try{let I=await fetch("/api/add-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:f.value.trim(),password:l.value})}),_=await I.json();!I.ok||!_.ok?c(_.error||"Failed to add user","error"):(c("User created successfully.","success"),y.reset(),P())}catch{c("Failed to add user","error")}finally{p&&(p.disabled=!1)}}),C?.addEventListener("submit",async v=>{if(v.preventDefault(),!E||!r||!a)return;b();let p=C.querySelector("button[type=submit]");p&&(p.disabled=!0);try{let I={username:r.value.trim(),password:a.value},_=await fetch(`/api/users/${E.value}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)}),O=await _.json();!_.ok||!O.ok?x(O.error||"Failed to update user","error"):(x("User updated.","success"),P(),setTimeout(()=>{s()},500))}catch{x("Failed to update user","error")}finally{p&&(p.disabled=!1)}}),P()}function Z(){let y=document.getElementById("playlistId")?.dataset?.playlistId,f=document.getElementById("playlistItems"),l=document.getElementById("videoLibrary");if(!y||!f||!l)return;let d=document.getElementById("playlistPicker"),S=document.getElementById("playlistMeta"),w=document.getElementById("playlistCount"),i=document.getElementById("playlistStatus"),C=document.getElementById("playlistSave"),E=document.getElementById("librarySearch"),r=document.getElementById("playlistDaysForm"),a=document.getElementById("playlistDaysStatus"),h=document.getElementById("playlistDaysCaption"),B=r?.querySelectorAll("[data-day-checkbox]"),o=null,T=null,A="",k=null,N=!1,D=[],c=e=>{let t=Math.round(Number(e)||0),n=Math.floor(t/3600),L=Math.floor(t%3600/60),F=t%60;return n>0?`${n}:${String(L).padStart(2,"0")}:${String(F).padStart(2,"0")}`:`${L}:${String(F).padStart(2,"0")}`},u=["sun","mon","tue","wed","thu","fri","sat"],x=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],b=e=>{let t=(e||"").split(",").map(n=>n.trim().toLowerCase()).filter(Boolean);return t.length?(t.sort((n,L)=>u.indexOf(n)-u.indexOf(L)),t.map(n=>{let L=u.indexOf(n);return L>=0?x[L]:n}).join(", ")):"Runs daily"};I(),_(),O(),d?.addEventListener("change",e=>{let t=e.target.value;t&&Number(t)!==Number(y)&&(window.location.href=`/playlists/${t}`)}),E?.addEventListener("input",()=>{A=E.value.trim(),clearTimeout(k),k=setTimeout(()=>O(A),250)}),C?.addEventListener("click",()=>R(!0)),r?.addEventListener("submit",async e=>{e.preventDefault();let t=[...B||[]].filter(n=>n.checked).map(n=>n.value);a&&(a.textContent="Saving\u2026");try{if(!(await fetch(`/api/playlists/${y}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({active_days:t})})).ok)throw new Error("Failed to save schedule");a&&(a.textContent="Saved schedule."),I()}catch(n){a&&(a.textContent=n.message||"Failed to save schedule.")}finally{a&&setTimeout(()=>{a.textContent=""},2500)}});function g(e,t=!0){!i||!e||(i.textContent=e,t&&setTimeout(()=>{i.textContent===e&&(i.textContent="")},2500))}function s(e){if(!B)return;let t=(e||"").split(",").map(n=>n.trim().toLowerCase()).filter(Boolean);B.forEach(n=>{n.checked=t.includes(n.value)}),h&&(h.textContent=t.length?`Active on ${b(e)}`:"Runs daily by default.")}function m(){f.querySelectorAll("[data-placeholder]").forEach(e=>e.remove())}function $(){if(f.querySelector("[data-item-id]")||f.querySelector("[data-placeholder]"))return;let e=document.createElement("li");e.dataset.placeholder="true",e.className="text-center text-gray-500 text-sm py-10",e.textContent="Drop videos here to start building your schedule.",f.appendChild(e)}function P(e,t=0){if(!w)return;let n=c(t);w.textContent=`${e} item${e===1?"":"s"} \u2022 ${n}`}function v(){let e=[...f.querySelectorAll("[data-item-id]")],t=e.reduce((n,L)=>n+(Number(L.dataset.duration||0)||0),0);P(e.length,t),e.length||$()}function p(){[...f.querySelectorAll("[data-item-id]")].forEach((e,t)=>{let n=e.querySelector(".slot-label");n&&(n.textContent=`Slot ${t+1}`)})}async function I(){try{let t=await(await fetch("/api/playlists")).json();D=t,d&&(d.innerHTML="",t.forEach(L=>{let F=document.createElement("option");F.value=L.id,F.textContent=L.name||`Playlist #${L.id}`,Number(L.id)===Number(y)&&(F.selected=!0),d.appendChild(F)}));let n=t.find(L=>Number(L.id)===Number(y));S&&(S.textContent=n?.name||`Playlist #${y}`),s(n?.active_days||"")}catch(e){console.error("Failed to load playlists",e)}}async function _(){try{let t=await(await fetch(`/api/playlists/${y}/items`)).json();f.innerHTML="",t.length?t.forEach(n=>f.appendChild(U(n))):$(),p(),v(),z()}catch(e){console.error("Failed to load playlist items",e)}}async function O(e=""){try{l.innerHTML='<div class="text-center py-6 text-gray-400 text-sm">Loading library\u2026</div>';let t=new URLSearchParams({limit:"100"});e&&t.set("q",e);let L=await(await fetch(`/api/videos?${t.toString()}`)).json(),F=Array.isArray(L)?L:L.rows||[];l.innerHTML="",F.length?F.forEach(ee=>l.appendChild(J(ee))):l.innerHTML='<div class="text-center py-10 text-gray-500 text-sm">No videos match that search.</div>',X()}catch(t){console.error("Failed to load library",t),l.innerHTML='<div class="text-center py-6 text-red-400 text-sm">Failed to load library.</div>'}}function J(e){let t=document.createElement("li");t.dataset.videoId=e.id,t.className="border border-white/10 rounded-2xl px-4 py-3 bg-white/5 backdrop-blur-sm cursor-grab hover:border-purple-400/40 transition flex items-center justify-between gap-3";let n=c(e.duration);return t.innerHTML=`
        <div>
          <p class="font-semibold text-white">${e.artist||"Unknown"} <span class="text-gray-400">\u2014 ${e.title||"Untitled"}</span></p>
          <p class="text-xs text-gray-400 uppercase tracking-wide">${e.genre||"Genre"} \u2022 ${e.year||"Year"} \u2022 ${n}</p>
        </div>
        <span class="text-xs text-gray-500">Drag</span>
      `,t}function U(e){let t=document.createElement("li");return j(t,e),H(t),t}function j(e,t){e.dataset.itemId=t.id,e.dataset.videoId=t.video_id,e.dataset.duration=Number(t.duration||0),e.className="border border-white/10 rounded-2xl px-4 py-3 bg-gradient-to-r from-purple-600/10 to-indigo-600/5 backdrop-blur flex items-center justify-between gap-4";let n=c(t.duration);e.innerHTML=`
        <div>
          <p class="font-semibold text-white">${t.artist||"Unknown"} <span class="text-gray-300">\u2014 ${t.title||"Untitled"}</span></p>
          <p class="text-xs text-gray-400 uppercase tracking-wide">${t.genre||"Genre"} \u2022 ${n}</p>
        </div>
        <div class="flex items-center gap-3 text-xs text-gray-400">
          <span class="slot-label hidden sm:inline">Slot ${t.position||"\u2014"}</span>
          <span class="drag-handle cursor-grab text-lg leading-none text-white/60 hover:text-white">\u22EE\u22EE</span>
          <button class="playlist-item-delete px-2 py-1 rounded-lg border border-red-400/40 text-red-200 hover:bg-red-500/20 transition">
            Remove
          </button>
        </div>
      `}function H(e){e.querySelector(".playlist-item-delete")?.addEventListener("click",()=>{Q(e.dataset.itemId,e)})}function X(){window.Sortable&&(o&&o.destroy(),o=new Sortable(l,{group:{name:"playlist-videos",pull:"clone",put:!1},sort:!1,animation:150,ghostClass:"opacity-50"}))}function z(){window.Sortable&&(T&&T.destroy(),T=new Sortable(f,{group:{name:"playlist-videos",pull:!0,put:!0},animation:200,ghostClass:"opacity-50",handle:".drag-handle",onAdd(e){let t=e.item.dataset.videoId;t&&(m(),!e.item.dataset.itemId&&K(t,e.item))},onUpdate(){R()}}))}async function K(e,t){try{let n=await fetch(`/api/playlists/${y}/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({video_id:Number(e)})}),L=await n.json();if(!n.ok||!L.ok||!L.item)throw new Error(L.error||"Failed to add video");j(t,L.item),H(t),p(),v(),await R(),g("Added video to playlist.")}catch(n){console.error(n),t.remove(),v(),alert(n.message||"Failed to add video to playlist")}}async function Q(e,t){if(e){t.classList.add("opacity-50");try{if(!(await fetch(`/api/playlists/${y}/items/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to remove item");t.remove(),p(),v(),g("Removed item from playlist.")}catch(n){t.classList.remove("opacity-50"),alert(n.message||"Failed to remove item")}}}async function R(e=!1){if(N)return;let t=[...f.querySelectorAll("[data-item-id]")].map(n=>Number(n.dataset.itemId));if(t.length){N=!0;try{if(!(await fetch(`/api/playlists/${y}/order`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:t})})).ok)throw new Error("Failed to save order");p(),v(),e&&g("Playlist order saved.")}catch(n){console.error(n),alert(n.message||"Failed to save playlist order")}finally{N=!1}}}}})();})();
