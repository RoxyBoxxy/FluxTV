<!DOCTYPE html>
<html class="h-full bg-gray-900 text-gray-100">
<head>
  <meta charset="utf-8" />
  <title><%= title || "FluxTV" %></title>
  <link rel="stylesheet" href="/public/styles.css">
  <link href="https://vjs.zencdn.net/8.23.4/video-js.css" rel="stylesheet" />
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.js"></script>

<script>
  MicroModal.init();
</script>
</head>

<body class="min-h-full flex flex-col">

  <!-- Top Navigation Bar -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-3 flex items-center justify-between sticky top-0 z-50">
    <div class="text-lg font-semibold flex items-center gap-2">
      <img style="height: 40px;" src="/public/img/logo_nav.png">
    </div>

    <% if (user) { %>
    <nav class="flex items-center gap-4">
      <a href="/" class="hover:text-pink-400 transition">Dashboard</a>
      <a href="/media" class="hover:text-pink-400 transition">Media</a>
      <a href="/playlists" class="hover:text-pink-400 transition">Playlists</a>
      <a href="/users" class="hover:text-pink-400 transition">Users</a>
      <a href="/settings" class="hover:text-pink-400 transition">Settings</a>
    </nav>
    <div class="flex items-center gap-3">
      <div id="ffmpeg-status" class="flex items-center gap-4 text-xs bg-gray-900 border border-gray-700 rounded-lg px-3 py-2">
        <div class="flex items-center gap-2">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></span>
          <span id="status" class="font-semibold">OFF AIR</span>
        </div>
        <div class="text-gray-400">FPS <span id="fps" class="text-gray-200">--</span></div>
        <div class="text-gray-400">LIVE <span id="live-time" class="text-gray-200">--:--</span></div>
        <button id="ffmpeg-toggle"
          class="ml-2 px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-[10px] font-semibold transition">
          START
        </button>
      </div>

      <form method="post" action="/logout">
      <button type="submit"
        class="ml-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition">
        Logout (<%= user.username %>)
      </button>
    </form>
    <% } %>
  </header>

  <!-- Main Body -->
  <main class="flex-1 p-6 pt-20">
    <%- body %>
  </main>

  <script type="module">
    const statusEl = document.getElementById("status");
    const fpsEl = document.getElementById("fps");
    const liveEl = document.getElementById("live-time");
    const dotEl = document.getElementById("status-dot");
    const toggleBtn = document.getElementById("ffmpeg-toggle");

    const wsProto = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProto}://${location.host}/api/ffmpeg/stats`);

    ws.onmessage = (e) => {
      const stats = JSON.parse(e.data);

      if (stats.running) {
        statusEl.textContent = "ON AIR";
        dotEl.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
        if (stats.running) {
          toggleBtn.textContent = "STOP";
          toggleBtn.className = "ml-2 px-2 py-1 rounded bg-red-600 hover:bg-red-700 text-[10px] font-semibold transition";
          toggleBtn.onclick = () => fetch("/api/ffmpeg/stop", { method: "POST" });
        } else {
          toggleBtn.textContent = "START";
          toggleBtn.className = "ml-2 px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-[10px] font-semibold transition";
          toggleBtn.onclick = () => fetch("/api/ffmpeg/start", { method: "POST" });
        }
      } else {
        statusEl.textContent = "OFF AIR";
        dotEl.className = "w-2 h-2 rounded-full bg-red-500";
        if (stats.running) {
          toggleBtn.textContent = "STOP";
          toggleBtn.className = "ml-2 px-2 py-1 rounded bg-red-600 hover:bg-red-700 text-[10px] font-semibold transition";
          toggleBtn.onclick = () => fetch("/api/ffmpeg/stop", { method: "POST" });
        } else {
          toggleBtn.textContent = "START";
          toggleBtn.className = "ml-2 px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-[10px] font-semibold transition";
          toggleBtn.onclick = () => fetch("/api/ffmpeg/start", { method: "POST" });
        }
      }

      fpsEl.textContent = stats.fps ? Number(stats.fps).toFixed(1) : "--";

      if (stats.out_time) {
        // stats.out_time is HH:MM:SS.microseconds
        const raw = stats.out_time.split(".")[0];
        const [hh, mm] = raw.split(":").map(Number);

        if (hh >= 24) {
          const days = Math.floor(hh / 24);
          const remHours = hh % 24;
          liveEl.textContent = `${days} Day${days !== 1 ? "s" : ""} ${String(remHours).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
        } else {
          liveEl.textContent = `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
        }
      } else {
        liveEl.textContent = "--:--";
      }
    };

    ws.onclose = () => {
      statusEl.textContent = "DISCONNECTED";
      dotEl.className = "w-2 h-2 rounded-full bg-gray-500";
      fpsEl.textContent = "--";
      liveEl.textContent = "--:--";
      toggleBtn.textContent = "START";
      toggleBtn.className = "ml-2 px-2 py-1 rounded bg-gray-700 text-[10px] font-semibold opacity-50 cursor-not-allowed";
      toggleBtn.onclick = null;
    };
  </script>
</body>
<footer>
  <script src="https://vjs.zencdn.net/8.23.4/video.min.js"></script>
  <script src="/public/ffmpegStatsClient.js"></script>
</footer>
</html>
